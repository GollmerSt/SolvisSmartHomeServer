Ä N D E R U N G E N

Version 01.00.13

	01.06.2020	Es werden nun die Laufzeiten der Solarpumpen in die Readings geschrieben. Dabei
				werden unter "C24.LaufzeitSolarpumpe" und "C25.LaufzeitSolarpumpe2" die ausgelesenen
				Werte aus "Sonstig./weiter/Zählfunktion" eingetragen.
				Zusätzlich gibt es eine sekundengenaue Berechnung unter "X9.LaufzeitSolarpumpe_s" und
				"X10.LaufzeitSolarpumpe2_s", welche auf dem Beobachten der Ausgänge "A01.Pumpe_Solar"
				bzw. A07.Pumpe_Solar2 beruhen.

    03.06.2020  Mailversand ist nun auch ohne Verschlüsselung möglich.
    
    			Der Mailversand ist nun standardmäßig deaktiviert und muss durch das Setzen des
    			Features "SendMailOnError" auf true erst aktiviert werden
    
    			



Version 01.00.12

	01.06.2020	In seltenen Fällen kam es nach dem Einschalten der Anlage beim Erscheinen des 
				Bildschirmschoners zu einer Nullpointer-Exception kommen, die zwar abgefangen
				wird. Der Screensaver wird dann als für eine begrenzte Zeit als User-Eingriff
				angesehen.

    29.05.2020  INFO-Logging-Ausgabe bei einem Solvis Zugriffsfehler wieder etwas erweitert.
    
    30.05.2020	Das Solvis-Url des base.xml wird nun durch jetzt auf Fehleingabe besser getestet.



Version 01.00.11

    23.05.2020  Die Logging-Library log4j2 wurde durch TinyLog ersetzt. Auf diese Weise wurde
                das Jar-Datei von 3,3 auf 1,3 MByte reduziert. Mir ist schleierhaft, warum ein
                Logging-Paket 2 MByte beansprucht, Tiny benötigt gerade mal 140 kByte.
                
    25.05.2020  Es wurde erkannt, dass bei dem Setzen des Tag-/Nacht-Sollwerte der lange
                Tastendruck manchmal als kurzer interpretiert wird. Das hat zur Folge, dass der
                Anlagenmodus verändert wird! Der Anlagenmodus wird nun vor diesen Befehlen
                gesichert und danch wieder restauriert. 


Version 01.00.10
    
    14.05.2020  Die Grafik des Bildschirmschoners ist an einigen Solvis-Anlagen nicht im Bild komplett
                drin, sondern auch teilweise außerhalb. Das wurde bei der Bildschirmschone nun
                berücksichtigt.
                
    15.05.2020  Beim Lesen von JSON-Daten wurden Zahlen immer in den Typ float umgewandelt. Das reicht
                auch normalerweise, weil die Genauigkeit für normale Messwerte ausreichend ist.
                Für die Übergabe der ClientId reichte das nicht, da in nicht in float ohne Rundungs-
                Verlust abgebildet werden kann. Das hatte zur Folge, dass nur selten ein Reconnect
                erfolgreich war.
            
    19.05.2020  Die Fehlermeldungs-Bildschirmüberwachung wurde überarbeitet.
                
    21.05.2020  FHEM-Client: GUI_COMMANDS_ENABLE/DISABLE wurde fälschlicherweise auch bei Wiederaufbau
                der Verbindung gesendet
                
    22.05.2020  Beim manuellen Wechsel auf den HomeScreen wird die Zeit etwas verspätet eingeblendet.
                Da die Anlagenfehlererkennung bisher dadurch erkannt wird, dass die Zeit nicht eingeblendet
                ist, erfolgte bisher in diesem Fall einen falsche Fehlermeldung. Nun wird zusätzlich
                getestet, ob in diesem Bereich eine Grafik vorhanden ist. Wenn ja, liegt ein
                Anlagenfehler vor.  


Version 01.00.09
                
    10.05.2020  Für die Steuerfiles base.xml und control.xml einen Check gegenüber die entsprechende
                xsd-Datei realisiert. Damit ist sichergestellt, dass dem Server kein fehlerhaftes oder
                zu altes xml-File einlesen muss.
                
    11.05.2000  Server-Command UPDATE_CHANNELS hinzugefügt. Er löst ein Aktualisieren sämtlicher nur über
                das GUI erreichbare Kanäle aus.
                
                control.xml bereinigt, es enthielt nicht mehr genutzte Einstellungen.
                
    12.05.2020  Die Passwort-Verschlüsselung kam nicht mit Passwörtern klar, welche eine Länge von
                14 + N * 16 und 15 + N * 16 hatten.


Version 01.00.08
                
    08.05.2020  Wegen der Artefakte am Rand der Anzeige an manchen Anlagen wurden bisher je 3 Pixel
                am Rand bei der Bildschirmschonererkennung nicht berücksichtigt.

    06.05.2020  Ein Bug im Client gefixt. Die Länge eines JSON-Pakets wurde fehlerhaft an den Server
                übergeben. Das führte dazu, dass bei zwei direkt vom Client gesendete JSON-Pakete
                der Anfang des zweiten verstümmelt war, wenn das erste noch nicht abgearbeitet war.
                Das führte sporadisch in der Verbindungsaufbau-Phase zu sporadischen Verbindungs-
                Abbrüchen.

    04.05.2020  Bei einem Update des Servers, bei dem sich die Struktur des control.xml-Files
                sich grundlegend geändert hat, konnte es passieren, dass der Server nicht mehr
                starten konnte. Der Server versucht zu Beginn immer die alte Datei zu lesen.
                Bei solchen größeren Änderungen kann es dabei passieren, dass er dies aber nicht
                mehr erfolgreich kann und sich beendet.
                In diesem Fall wird nun von der alten control.xml ein Backup erstellt (ob diese
                vom Anwender geändert wurde kann nicht mehr festgestellt werden) und mit der
                neuen des Programmpakets überschrieben.
                
                Das gleiche kann auch für die Datei graphics.xml zutreffen. Wenn die nicht mehr
                gelesen werden kann, wird sie immer neu erstellt, d.h. ein Learning wird notwendig.


Version 01.00.07
                
    01.05.2020  FHEM-Client um einige Logs erweitert und von einem unnötigen Teil bereinigt, der
                in einem besonderen Fall stundenlang verhindern konnte, dass er sich wieder mit
                dem Server verbindet.
                    

Version 01.00.06
                
    28.04.2020  Im Zusammenhang mit der Modbus-Ergänzung ist auch die Laufzeitanforderung 2 nicht mehr
                optional gewesen. Gefixt.
                
                Wird ein Control-Befehl verworfen, werden fälschlicherweise noch weitere nicht
                abgearbeitete verworfen.
                
    29.04.2020  Der Bildschirmschoner wurde immer wieder zurückgesetzt.
    
                Es kam durch asynchrone Zugriffe auf die SolvisControl2 immer noch zu falschen
                Fehlermeldungen. Algorithmus geändert.
    
                Log4J aktualisiert, Version 2.13.2
                
                Makefile geändert. Die vorherige base.xml wird gesichert als base.xml.old
                
                Ant-File geändert. Im Packet ist anstelle der base.xml immer einen base.xml.new
                enthalten. Auf diese Weise wird die vom Anwender geänderte base.xml beim Transfer
                nicht überschrieben
                

Version 01.00.05
                
    28.04.2020  Die XML-Struktur des control.xml-Files musste durch die Modbus-Ergänzung geändert
                werden. Durch ein Bug funktionierte danach die Solvis-Konfiguration ohne Raumfühler
                nicht mehr. 
                

Version 01.00.04
                
    28.04.2020  Heizkreis 2-Problem gefixt. Wenn das Heizkreis2-Menü angefahren werden sollte, wurde
                im Bildschirm "Heizkreise" fälschlicherweise der Button für den heizkreis 1 gedrückt
                
                Uninstall über das makefile funktionierte nicht mehr, gefixt
                

Version 01.00.03
                
    26.04.2020  Es war möglich, dass bei einem User-Zugriff eine Fehler-Mail gesendet wurde, wenn
                ausgerechnet der Bildschirm in diesem Moment gescannt wurde. In diesem Fall ist das
                Gelesene ein Mix von verschiedenen Bildschirmen, der die Kriterien für einen
                Fehlerbildschirm erfüllen kann. Nun wird nach einer Detection nach 100ms
                der Bildschirm erneut abgetastet.
                
    27.04.2020  Fehlerhafte Daten bei dem ExeptionMail in den base.xml-Daten führen nicht mehr zum
                Beenden des Servers. Die Fehler werden zwar gemeldet, aber in der Weise ignoriert,
                dass keine Fehler-Meldungs-Mails verschickt werden.
                 
                Durch einen Invertierfehler wurden die Heizkreisbuttons bei Anlagen mit mehr als 
                einem Heizkreis nicht gedrückt.
                
                Einige Kanäle zeigten noch einen um Faktor 10 zu hohen Wert an
                

Version 01.00.02
                
    17.04.2020  Die Erkennung von Power-Off bewirkt ein direktes Senden sämtlicher
                Werte der Kanäle. Auf dieser Weise bleiben die Diagramme trotz power off
                halbwegs plausibel
                
    21.04.2020  Verschlüsselung der Passwörter implementiert. Passworte sind nun
                verschlüsselt in die base.xml einzutragen 
    
                Mailversand bei Solvis-Anlagen-Fehler implementiert
                
                Makefile erweitert. Es gibt 2 zusätzliche Aufrufmöglichkeiten:
                    sudo make crypt:    Fragt nach einem zu verschlüsselnden Wort
                                        und gibt es verschlüsselt aus.
                                        Dies dient der Erzeugung der in die base.xml
                                        nun verschlüsselt einzutragenden Passwörter.
                    sudo make testmail: Versendet eine Test-Mail
                    
    22.04.2020  Deadlock-Problem behoben. Die Erkennung von PowerOff führte in bestimmten
                Fällen zu einem Deadlock.
                
    25.04.2020  Endlos-Schleife bei Anlagen mit mehr als einem Heizkreis gefixt.


Version 01.00.01

    15.03.2020  control.xsd erweiter für Modbus
    
    24.03.2020  Fhem-Client: Umgestellt auf FHEM::MaxClient-Package, FHEM::Meta-Support
    
                Synchronisations-Fehler gefixt: Wenn zwei Clients gleichzeitig versuchen sich
                mit dem Server zu verbinden, konnte es zu einem fehlerhaften Zustand des Servers
                führen, so dass anschließend keine Verbindungen mehr möglich waren.
                
    26.03.2020  Clock-Adjustment funktionierte bei einer Differenz von mehr als 19h nicht mehr
    
    02.04.2020  Die Gui-Steuerung funktionierte nach Power-Off nicht mehr, wenn das Feature
                PowerOffIsServiceAccess aktiviert war.
                
                Nach einem User-Zugriff wurde weder die WW-Temperatur noch der Status der
                WW-Pumpe aktualisiert

Version 00.11.02

    29.02.2020  Fine-Tuning der Solvis-Uhr entfernt. Da das Setzen der Uhr sporadisch zu 
                Abstürzen der Solvis-Uhr führt und an meiner Anlage die Solvis-Anlage sich
                danach nicht mehr in den vorherigen Zustand befand (Timer-Betrieb anstelle von
                Tag), wurde dies jetzt deaktiviert. Dadurch entfallen im base.xml das Element
                "ClockAdjustment" komplett sowie das Feature "ClockFineTuning".
                
    01.03.2020  Command-Queue weiter optimiert. Es werden jetzt immer alle definierten Werte
                eines Screens ausgelesen, auch wenn nur einer ausgelesen bzw. verändert wird.
                
                Parameter "doubleUpdateInterval_ms" in der base.xml eingeführt. Mit diesem
                Parameter bewirkt man symmetrisch um den Zeitpunkt, zu dem forcedUpdateInterval_ms
                wirkt, ein Senden von zwei Messungspaketen, eines zum im Abstand von
                "doubleUpdateInterval_ms". Setzt man das forcedUpdateInterval auf 1h,
                so erreicht man in FHEM in Diagrammen auch bei maximaler bei FHEM-Diagrammen
                auch bei Vergrößerungen durchgehende Linien.
                
    6.03.2020   Der Service-Access wurde nicht automatisch nach 1h zurückgesetzt, da bei der
                Anzeige des Bildschirmschoners (was nach 1h immer der Fall ist) der
                Service-Access-Mode durch ein Bug nicht verlassen werden konnte.
                
                
                

Version 00.11.01

    11.02.2020  Die berechneten Werte (Xx...) wurden erst dann zum Client geschickt, wenn
                sie sich nach dem Neustart des Servers einmal verändert hatten.
                
                Kanal S11 korrigiert. Name und Einheit geändert
                
                
    14.02.2020  Synchronisations-Problem zwischen stündlichem und sofortigem Update der
                Fhem-Daten gefixt. Führte sporadisch zu Null-Pointer-Exceptions.
                
                Server-Befehle GUI_COMMANDS_ENABLE/GUI_COMMANDS_DISABLE eingeführt, um sicher
                zu stellen, dass im Wartungsfall der Anlage der Server nicht für den Service-
                Mitarbeiter Unerklärbares ausführt.
                
    17.02.2020  Das Web-GUI der SolvisControl ist abhängig von der TouchScreen-Kalibrierung!
                Das kann sich in leichten Versatz, im ungünstigsten Fall durch Artefakte am
                Rande äußern. Da sowohl die Verschiebung als auch die Artefakte die Erkennung
                stören kann, wird nun in der Learningphase dieser Versatz aus dem Home-Screen
                ermittelt und entsprechend korrigiert. Dazu wird das rechte Aufeinandertreffen
                der Linien zwischen den Wasser- und Solarbuttons des Home-Screen hergenommen.
                
    18.02.2020  Neues Features:
                Service-User-Zugriffe werden nun über die Bildschirme "Schornsteinfeger",
                "Nutzerauswahl", "Nutzerauswahl Codeeingabe" erkannt. Die GUI-Befehle sind
                unterdrückt, solange die SolvisControl diese Bildschirme anzeigt. Außerdem hat das
                zur Folge, dass nun jeder weitere erkannte Nutzer-Eingriff eine Sperrung der
                GUI-Befehle für eine Stunde bewirkt (sonst 5 Minuten). Erst wenn diese Stunde
                überschritten ist, ist der Server im normalen Mode. Will man letztere Zeit
                verringern, kann man den Server über den Fhem-Client mit dem Server-Command
                "SERVICE_RESET" wieder in den normalen Zustand bringen.
                
                Der User kann nun über die base.xml bestimmen, welche GUI-Features des Servers
                aktiviert sein sollen. Die base.xml wurde dazu um ein "Feature"-Element erweitert.
                Die im Paket mitgelieferte base.xml hat sämtliche GUI Features deaktiviert!
                Auf diese Weise greift der Server erstmal nicht aktiv in die Bedienung ein.
                Der User bestimmt, was er freischalten will.
                
                Fhem-Client um das Attribut "GuiCommandsEnabled" ergänzt. Ist dieses Attribut auf
                FALSE, werden sämtliche Kommandos verhindert, welche das GUI der SolvisControl
                benötigen. Nur Messwerte werden aufgezeichnet. TRUE lassen die Kommandos wieder zu.
                Der Hintergrund ist der, dass Service-Mitarbeiter nicht durch diese Automatiken
                irritiert werden und einen Defekt der Anlage vermuten. SET/GET-Kommandos,
                welche in dieser Zeit
                erfolgen, werden zwischengepuffert und ausgeführt, wenn das Attribut wieder auf
                TRUE gesetzt wurde.
    
    22.02.2020  Die Ermittlung des Origins wurde wieder ausgebaut, da die Berücksichtigung der
                Kalibrierung in der SolvisControl nicht auf allen Bildschirmen berücksichtigt wird.
                So sind die Bilder des Anlagenstatus unabhängig von der Kalibrierung. Rein theoretisch
                hätte man das berücksichtigen können, aber da es sich bei der Touchscrenn-Kalibrierung
                es sich nur um wenige Pixel handelt, welche das Bild verschoben sein kann, muss
                dieser Einfluss grundsätzlich bei der Definition der Abmessungen der Grafiken
                beachtet werden. Die Bildschirmschoner-Erkennung wurde angepasst, die äußeren
                3 Pixels werden nicht berücksichtigt.
                
    25.02.2020  Im Fehler-Status der Solvis-Anlage wurde auch noch zusätzlich der Kanal
                "A14.Entstoerung" berücksichtigt.
                Ist dieser gesetzt, geht der Status der Anlage ebenfalls auf Fehler.
                Über die control.xml können noch weitere Kanäle hinzugefügt werden, es müssen
                entsprechend noch weitere ErrorCondition-Elemente hinzugefügt werden.
                
                Die control.xml (im "writablePath", definiert im base.xml), der wird nun nicht
                mehr bei jedem Start des Servers überschrieben. Erst wenn in einem Update eine
                aktualisierte conttrol.xml existiert, wird einen evtl. vorhandene editierte
                "control.xml" in "control.xml.1" umbenannt. Es werden dabei immer die letzten
                3 editierten "control.xml"-Dateien gesichert. Es handelt sich dabei um
                "control.xml.1", "control.xml.2" und "control.xml.3".
                Nur wenn die "control.xml" editiert wurde oder die graphics.xml nicht vorhanden
                ist, erfolgt dieser Vorgang.
    

Version 00.10.06

    08.02.2020  Bewirkt ein Control-Command mehr als 2 Fehler, wird er an das Ende der Queue
                geschoben und eine Fehlermeldung wird in den Log geschrieben. Bei 10 Fehlern
                wird er aus der Queue entfernt. Auf diese Weise wird verhindert, dass ein
                 nichtausführbarer Befehl die Command-Queue blockiert.
                
                Debug-Meldungen von Info auf Debug gesetzt.
                
                Den SolvisClient noch um die Beschreibung der verschiedenen state-Werte ergänzt.  
    
    


Version 00.10.05

    07.02.2020  Bei Brenner-Laufzeit-Synchronisation war Screen-Restore invertiert.
                Bei einem moduliertem Gasbrenner gibt es keinen "C03.LaufzeitAnforderung2".
                Der fehlende Wert wird ignoriert und durch 0 ersetzt.
    
    


Version 00.10.04

    07.02.2020  Einige Info-Messages zum besseren Debuggen der Colmmand-Queue eingeführt
                
                Bei Brenner-Laufzeit-Synchronisation war Screen-Restore invertiert.
    
    


Version 00.10.03

    06.02.2020  control.xml korrigiert. Bei der Konfiguration SolvisMax + Solarmodul war der
                Bildschirm des Solar-Anlagenstatus nicht definiert
                
                Bei fehlenden Definition eines Bildschirmreferenz kam es zu einer Null-Pointer-
                Exception. Es erscheint nun eine sinnvolle Fehlermeldung.
    
    


Version 00.10.02

    20.01.2020  Clock-Fine-Tuning implementiert. Man kann die Solvis-Uhr doch genauer einstellen,
                wenn man mehrfach auf den OK-Button der Zeieinstellung drückt. Jedes Stellen der
                Uhr, bewirkt, dass die Zeit kurz "angehalten" wird. Das kann man nutzen, wenn die 
                Solvis-Uhr genauer eingestellt werden soll, ist aber mehr eine Spielerei
                (Wer benötigt eine genau gehende Solvis-Anlagen-Uhr, der ein Smarthome-System
                besitzt?).

                
    21.02.2020  Restart des Servers nun auch vom Client möglich.
                
                Client-Server-Schnittstelle etwas geändert. Server übergibt bei Herstellung der
                Verbindung zum Client nun die möglichen Server-Befehle. Daher wurden ebenfalls
                Änderungen am Client notwendig.

    
    23.01.2020  Bug beim Setzen der Uhr behoben. Uhr wurde nicht mehr angeglichen, wenn der Server
                in einem bestimmten Zeitintervall gestartet wurde und ein Abgleich der Uhr beim
                Start notwendig war.

                
    25.01.2020  Error-Detection erweitert. Der Status der Solvis-Anlage ist auch dann in dem
                Error-Status, wenn auf dem Home-Bildschirm rechts nicht mehr die Uhrzeit mit dem
                Datum angezeigt wird, sondern ein Button mit einem Achtung-Zeichen.

                
    29.01.2020  Contol-Command-Optimierung deaktivierbar

    
    30.01.2020  Bug im Uhr-Abgleich behoben. Es wurde nicht beachtet, dass zum Zeitpunkt der Uhreinstellung
                (Klick auf den OK-Button) gerade der Minutenwechsel der Solvis-Uhr erfolgen kann. In diesem
                Fall war es möglich, dass die Solvis-Uhr danach um 60s nach ging. Der Einstellzeitpunkt ist
                nun zum Zeitpunkt hh:mm:05 (nach Solvis-Zeit).

    
    31.01.2020  In der Statistik des Uhrenabgleichs wurde eine Auffälligkeit erkannt:
                Die Solvis-Steuerung kann sporadisch beim Einstellen der Uhr abstürzen! Das
                erfolgt nach Langzeitbeobachtung mit der Wahrscheinlichkeit von etwa 1:200.
                In diesem Fall erfolgt ca. 10s keinerlei Reaktion von der SolvisControl.
                Nach Ablauf dieser Zeit scheint ein Watch-Dog der SolvisControl den Hänger
                erkannt zu haben, der dann anschließend die komplette Steuerung zurücksetzt.
                Dieses Verhalten wird letztlich von Solvis bestätigt:
                  "Wenn man die Uhrzeit verstellt, kann es passieren, dass Timer unkontrolliert
                   überlaufen und die Funktionen dann neu gestartet werden. Das ist aber kein
                   Fehler, sondern eine Reaktion auf die geänderten Parameter."
                Das hat zur Folge, dass ein laufender Brenner stoppt und der Mischer erstmal auf
                die Null-Position zurück fährt. Auch behält die Anlage nicht die Einstellung der
                WW-Pumpe, sie geht - wie beim  Einschalten - auf den Modus "Auto". Aus
                Sicherheitsgründen ist das Stellen der Uhr nun abhängig vom Brenner, wenn er
                läuft, erfolgt kein Einstellen. Selbst wenn das automatische Rücksetzen der
                SolvisContriol dann doch mal ausbleiben sollte (was ich nie beobachtet hatte),
                kann nichts schlimmes passieren. Auch laufendes WW unterbindet das Stellen der
                Uhr. Wer ganz auf Nummer sicher gehen will deaktiviert das automatische Stellen
                der Uhr im "base.xml"-File

                
    04.02.2020  Der Watch-Dog muss auch zwischen den Kommandos ausgeführt werden, welche über
                das GUI der SolvisControl gehen, andernfalls wird u.U. der Screen-Saver nicht
                erkannt.
                
                Kleiner Bug bei der Synchronisation der Brenner-Laufzeit behoben. Screen blieb
                im Synchronisationsfall bis zum Ende der Brenner-Laufzeit gelockt, auch wenn die
                Synchronisation längst abgeschlossen war.

                
    05.02.2020  Bei SolvisRemote-Firmware < 2.21.02A gibt es einen IOException, welche ignoriert
                werden muss.
                Die base.xml daher um das Attribut "fwLth2_21_02A" ergänzt, das auf true gesetzt
                werden muss, wenn die SolvisRemote mit einer älteren FW geflasht ist.




Version 00.10.01

    15.01.2020  Average-Routine geändert. Einzelne Messausreißer konnten die angezeigte
                Genauigkeit der Sensoren stark reduzieren. Es wurde daher der Algorithmus
                geändert und in der Datei das Attribut "measurementHysteresisFactor"
                eingeführt.
                
    16.01.2020  Die Erkennung von User-Eingriffen funktionierte nicht mehr. Fixed.
    
    17.01.2020  Modus mit mehr als einem Heizkreis übverarbeitet und sowei möglich getestet.
    
    


Version 00.10.00
    1. Release